{% extends "bases/private.html" %}

{% block title %}Family Management - StewardWell{% endblock %}

{% block content %}
<div class="dashboard">
  <h1>Family Management</h1>

  {% if not family %}
    <p>You are not part of a family yet. Create or join one to manage members.</p>
  {% else %}
    <div class="family-info" style="margin-bottom: 1rem;">
      <h3>{{ family.name }}</h3>
      <p><strong>Family Code:</strong> {{ family.family_code }}</p>
    </div>

    <div class="family-actions" style="margin-top: 1rem;">
      <div class="action-card">
        <h4>Members</h4>
        {% if members %}
          <ul>
            {% for m in members %}
              <li>{{ m.username }}{% if m.id == family.creator_id %} (Manager){% endif %}</li>
            {% endfor %}
          </ul>
        {% else %}
          <p>No other members yet.</p>
        {% endif %}
        {% if is_manager %}
          <form method="POST" action="{{ url_for('family_mgmt.invite_adult') }}" style="margin-top: 1rem;">
            <div class="form-group">
              <label for="identifier">Invite adult (username or email):</label>
              <input type="text" id="identifier" name="identifier" placeholder="username or email" required>
            </div>
            <button class="btn btn-primary btn-small" type="submit">Send Invite</button>
          </form>
        {% endif %}
      </div>

      <div class="action-card">
        <h4>Children</h4>
        <form method="POST" action="{{ url_for('child.add_child') }}" class="inline-form">
          <div class="form-group">
            <label for="child_name">Child Name:</label>
            <input type="text" id="child_name" name="child_name" required>
          </div>
          <div class="form-group">
            <label for="child_age">Age (optional):</label>
            <input type="number" id="child_age" name="child_age" min="0" max="18">
          </div>
          <button type="submit" class="btn btn-primary">Add Child</button>
        </form>
        {% if children %}
          <div class="children-list" style="margin-top: 1rem;">
            {% for child in children %}
              <div class="child-card">
                <div class="child-info">
                  <h5>{{ child.name }}</h5>
                  {% if child.age %}<p>Age: {{ child.age }}</p>{% endif %}
                </div>
                <div class="child-actions">
                  <a href="{{ url_for('child.delete_child', child_id=child.id) }}" class="btn btn-danger btn-small" onclick="return confirm('Remove {{ child.name }}?')">Remove</a>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <p class="no-children">No children added yet.</p>
        {% endif %}
      </div>

      <div class="action-card">
        <h4>Pending Join Requests</h4>
        {% if is_manager %}
          {% if pending %}
            <ul>
              {% for req in pending %}
                <li>
                  {{ req.user.username }}
                  <a class="btn btn-primary btn-small" href="{{ url_for('family_mgmt.approve', req_id=req.id) }}">Approve</a>
                  <a class="btn btn-danger btn-small" href="{{ url_for('family_mgmt.reject', req_id=req.id) }}">Reject</a>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p>No pending requests.</p>
          {% endif %}
        {% else %}
          <p>Only the family manager can view and manage join requests.</p>
        {% endif %}
      </div>
    </div>
  {% endif %}
</div>
{% endblock %}
